<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>School App</title>
  <!--
    NOTE: As per the user's feedback, the Tailwind CDN is used here for simplicity.
    For a production application, it should be installed as a PostCSS plugin.
    More info here: https://tailwindcss.com/docs/installation
  -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!--
    This script loads the bcrypt library globally.
    It must be loaded before the main script that uses it.
  -->
  <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.js"></script>
  <style>
    /*
      This is the CSS from the previous version, now inline in the HTML.
      It uses Tailwind CSS utility classes to style the app's components.
    */
    .app-input {
      @apply w-full px-4 py-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500;
    }
    .app-button-primary {
      @apply w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 transition duration-300;
    }
    .app-button-secondary {
      @apply w-full bg-green-600 text-white font-semibold py-3 rounded-lg hover:bg-green-700 transition duration-300;
    }
    .app-button-danger {
      @apply w-full bg-red-500 text-white font-semibold py-3 rounded-lg hover:bg-red-600 transition duration-300;
    }
    .app-message {
      @apply mt-4 text-center text-sm;
    }
  </style>
</head>
<body>

  <div id="app-container" class="min-h-screen flex items-center justify-center p-4">

    <!-- Login Page -->
    <div id="login-page" class="app-page bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
      <h2 class="text-3xl font-bold text-gray-800 text-center mb-6">School Login</h2>
      <input type="text" id="login-school-id" placeholder="School ID" class="app-input" />
      <input type="password" id="login-password" placeholder="Password" class="app-input" />
      <button id="login-btn" class="app-button-primary">Login</button>
      <p class="mt-4 text-center text-sm text-gray-600">
        Don't have an account?
        <a href="#" id="go-to-register" class="text-indigo-600 font-medium hover:underline">Register here</a>
      </p>
      <p id="login-message" class="app-message text-red-500"></p>
    </div>

    <!-- Registration Page -->
    <div id="register-page" class="app-page bg-white p-8 rounded-lg shadow-xl w-full max-w-md hidden">
      <h2 class="text-3xl font-bold text-gray-800 text-center mb-6">School Registration</h2>
      <input type="text" id="register-school-id" placeholder="School ID" class="app-input" />
      <input type="password" id="register-password" placeholder="Password" class="app-input" />
      <button id="register-btn" class="app-button-secondary">Register</button>
      <p class="mt-4 text-center text-sm text-gray-600">
        Already have an account?
        <a href="#" id="go-to-login" class="text-green-600 font-medium hover:underline">Login here</a>
      </p>
      <p id="register-message" class="app-message text-red-500"></p>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboard-page" class="app-page bg-indigo-500 text-white p-8 rounded-lg shadow-xl w-full max-w-md hidden">
      <h2 class="text-3xl font-bold text-center mb-4">Welcome to the Dashboard!</h2>
      <p class="text-center text-gray-600 mb-6">
        This is the collaboration space. You are successfully logged in.
      </p>
      <div class="flex flex-col items-center mb-6">
        <p class="font-semibold text-lg text-gray-700">Logged in as School:</p>
        <p id="dashboard-school-id" class="text-xl font-bold text-indigo-600 mt-1"></p>
      </div>
      <p id="dashboard-user-id" class="text-sm text-center text-gray-500 mb-6"></p>
      <button id="logout-btn" class="app-button-danger">Logout</button>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm">
        <h3 id="message-box-title" class="text-xl font-bold mb-2"></h3>
        <p id="message-box-text" class="text-gray-700 mb-4"></p>
        <button id="message-box-close" class="app-button-primary w-full">OK</button>
      </div>
    </div>
  </div>

  <!--
    This is the main application script.
    The `type="module"` attribute is crucial for the `import` statements to work.
  -->
  <script type="module">
    // Firebase SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables provided by the Canvas environment
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';

    // DOM elements
    const loginPage = document.getElementById('login-page');
    const registerPage = document.getElementById('register-page');
    const dashboardPage = document.getElementById('dashboard-page');
    const loginBtn = document.getElementById('login-btn');
    const registerBtn = document.getElementById('register-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const goToRegisterLink = document.getElementById('go-to-register');
    const goToLoginLink = document.getElementById('go-to-login');
    const loginSchoolIdInput = document.getElementById('login-school-id');
    const loginPasswordInput = document.getElementById('login-password');
    const registerSchoolIdInput = document.getElementById('register-school-id');
    const registerPasswordInput = document.getElementById('register-password');
    const loginMessage = document.getElementById('login-message');
    const registerMessage = document.getElementById('register-message');
    const dashboardSchoolId = document.getElementById('dashboard-school-id');
    const dashboardUserId = document.getElementById('dashboard-user-id');
    const messageBox = document.getElementById('message-box');
    const messageBoxTitle = document.getElementById('message-box-title');
    const messageBoxText = document.getElementById('message-box-text');
    const messageBoxCloseBtn = document.getElementById('message-box-close');

    // Firebase services
    let db, auth;
    let currentUser = null;

    // Helper function to show a custom message box instead of alert()
    const showMessage = (title, text) => {
      messageBoxTitle.textContent = title;
      messageBoxText.textContent = text;
      messageBox.style.display = 'flex';
    };

    const hideMessageBox = () => {
      messageBox.style.display = 'none';
    };

    messageBoxCloseBtn.addEventListener('click', hideMessageBox);

    // Function to handle page switching
    const showPage = (pageName) => {
      loginPage.style.display = 'none';
      registerPage.style.display = 'none';
      dashboardPage.style.display = 'none';

      switch (pageName) {
        case 'login':
          loginPage.style.display = 'block';
          break;
        case 'register':
          registerPage.style.display = 'block';
          break;
        case 'dashboard':
          dashboardPage.style.display = 'block';
          break;
      }
    };

    // Function to handle registration
    const handleRegister = async () => {
      const schoolId = registerSchoolIdInput.value;
      const password = registerPasswordInput.value;

      if (!schoolId || !password) {
        showMessage('Error', 'School ID and password are required.');
        return;
      }

      try {
        const docRef = doc(db, `/artifacts/${appId}/public/data/schools`, schoolId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          showMessage('Error', 'School ID already exists. Please choose another.');
        } else {
          const saltRounds = 10;
          const hashedPassword = await bcrypt.hash(password, saltRounds);

          await setDoc(docRef, {
            schoolId,
            passwordHash: hashedPassword,
          });
          showMessage('Success', 'Registration successful! Please log in.');
          showPage('login');
          registerSchoolIdInput.value = '';
          registerPasswordInput.value = '';
        }
      } catch (error) {
        console.error("Registration failed:", error);
        showMessage('Error', `Registration failed: ${error.message}`);
      }
    };

    // Function to handle login
    const handleLogin = async () => {
      const schoolId = loginSchoolIdInput.value;
      const password = loginPasswordInput.value;

      if (!schoolId || !password) {
        showMessage('Error', 'School ID and password are required.');
        return;
      }

      try {
        const docRef = doc(db, `/artifacts/${appId}/public/data/schools`, schoolId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          const { passwordHash } = docSnap.data();
          const match = await bcrypt.compare(password, passwordHash);

          if (match) {
            showMessage('Success', 'Login successful!');
            dashboardSchoolId.textContent = schoolId;
            dashboardUserId.textContent = `Current User ID: ${currentUser?.uid || 'N/A'}`;
            showPage('dashboard');
            loginSchoolIdInput.value = '';
            loginPasswordInput.value = '';
          } else {
            showMessage('Error', 'Invalid password.');
          }
        } else {
          showMessage('Error', 'School ID not found.');
        }
      } catch (error) {
        console.error("Login failed:", error);
        showMessage('Error', `Login failed: ${error.message}`);
      }
    };

    // Function to handle logout
    const handleLogout = async () => {
      try {
        await signOut(auth);
        showPage('login');
        showMessage('Logged Out', 'You have been successfully logged out.');
      } catch (error) {
        console.error("Logout failed:", error);
        showMessage('Error', `Logout failed: ${error.message}`);
      }
    };

    // Event listeners for page navigation and actions
    goToRegisterLink.addEventListener('click', (e) => {
      e.preventDefault();
      showPage('register');
      registerMessage.textContent = '';
    });

    goToLoginLink.addEventListener('click', (e) => {
      e.preventDefault();
      showPage('login');
      loginMessage.textContent = '';
    });

    loginBtn.addEventListener('click', handleLogin);
    registerBtn.addEventListener('click', handleRegister);
    logoutBtn.addEventListener('click', handleLogout);

    // Initialize the app on window load
    window.onload = async () => {
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Set up auth state change listener
        onAuthStateChanged(auth, async (user) => {
          if (user) {
            currentUser = user;
            // A logged-in user exists, show the dashboard or login page
            showPage('login');
          } else {
            currentUser = null;
            showPage('login');
          }
        });

        if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
        } else {
            await signInAnonymously(auth);
        }

      } catch (error) {
        console.error("Firebase initialization failed:", error);
        showMessage('Error', "Failed to initialize the app. Please try again later.");
      }
    };
  </script>
</body>
            </html>
            
