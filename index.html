<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML/JS To-Do List</title>
    <!-- We're using Tailwind CSS for easy and beautiful styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Import the Firebase SDKs -->
    <script type="module">
        // Import the necessary Firebase modules.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp, orderBy, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables to hold our Firebase instances.
        let app, db, auth;
        // User ID variable to manage user-specific data.
        let userId = null;

        // Function to initialize Firebase and set up listeners.
        const initFirebase = async () => {
            try {
                // Get the Firebase configuration from the Canvas environment.
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                // Initialize the app.
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Wait for the authentication state to be ready.
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in.
                        userId = user.uid;
                        // Start the Firestore listener for to-do items.
                        setupFirestoreListener();
                        // Display the user ID on the page.
                        document.getElementById('user-id').textContent = userId;
                    } else {
                        // User is signed out, try to sign in anonymously or with custom token.
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
            }
        };

        // Function to set up the real-time listener for Firestore data.
        const setupFirestoreListener = () => {
            if (!db || !userId) {
                console.error("Database or user ID not available.");
                return;
            }

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const todosCollectionPath = `/artifacts/${appId}/users/${userId}/todos`;
            const todosCollection = collection(db, todosCollectionPath);
            const q = query(todosCollection);

            // onSnapshot listens for real-time changes.
            onSnapshot(q, (snapshot) => {
                const todos = [];
                snapshot.forEach(doc => {
                    todos.push({ id: doc.id, ...doc.data() });
                });
                // Sort todos by creation timestamp to maintain order.
                todos.sort((a, b) => a.createdAt.seconds - b.createdAt.seconds);
                // Render the updated list of todos.
                renderTodos(todos);
            }, (error) => {
                console.error("Error getting documents:", error);
            });
        };

        // Renders the to-do list on the page.
        const renderTodos = (todos) => {
            const listContainer = document.getElementById('todo-list-container');
            listContainer.innerHTML = ''; // Clear the existing list.

            if (todos.length === 0) {
                listContainer.innerHTML = `
                    <p class="text-center text-gray-500 italic mt-4">
                        Your to-do list is empty! Add a new task above.
                    </p>
                `;
                return;
            }

            todos.forEach(todo => {
                const todoItem = document.createElement('div');
                todoItem.className = 'flex items-center justify-between bg-white p-4 rounded-xl shadow transition-all duration-200 hover:bg-gray-100';
                todoItem.dataset.id = todo.id;
                todoItem.innerHTML = `
                    <div class="flex items-center gap-3">
                        <input type="checkbox" ${todo.completed ? 'checked' : ''} class="task-checkbox w-5 h-5 text-blue-600 bg-white border-gray-300 rounded focus:ring-blue-500 transition-colors cursor-pointer" />
                        <span class="task-text text-black text-base md:text-lg ${todo.completed ? 'line-through text-gray-500' : ''} transition-colors duration-200">
                            ${todo.text}
                        </span>
                        <input type="text" class="edit-input hidden flex-grow p-2 text-sm text-black bg-white rounded-lg border border-gray-300 focus:outline-none focus:ring-1 focus:ring-blue-500" value="${todo.text}" />
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="edit-btn text-gray-500 hover:text-blue-500 transition-colors duration-200" aria-label="Edit todo">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-3.832 7.078l-3.32 3.32a1 1 0 01-.409.288l-3.23 1.077a.5.5 0 01-.62-.62l1.076-3.23a1 1 0 01.288-.409l3.32-3.32 2.828 2.828z" />
                            </svg>
                        </button>
                        <button class="save-btn hidden p-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">
                            Save
                        </button>
                        <button class="cancel-btn hidden p-2 text-sm font-medium text-white bg-gray-500 rounded-lg hover:bg-gray-600 transition-colors">
                            Cancel
                        </button>
                        <button class="delete-btn text-gray-500 hover:text-blue-500 transition-colors duration-200" aria-label="Delete todo">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
                listContainer.appendChild(todoItem);
            });
        };
        
        // Adds a new to-do item to Firestore.
        const addTodo = async (text) => {
            if (!db || !userId) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const todosCollectionPath = `/artifacts/${appId}/users/${userId}/todos`;

            try {
                await addDoc(collection(db, todosCollectionPath), {
                    text: text,
                    completed: false,
                    createdAt: serverTimestamp(),
                });
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        };

        // Toggles the 'completed' status of a to-do.
        const toggleComplete = async (id, completed) => {
            if (!db || !userId) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const todoDocRef = doc(db, `/artifacts/${appId}/users/${userId}/todos`, id);

            try {
                await updateDoc(todoDocRef, {
                    completed: !completed
                });
            } catch (e) {
                console.error("Error updating document: ", e);
            }
        };

        // Deletes a to-do item.
        const deleteTodo = async (id) => {
            if (!db || !userId) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const todoDocRef = doc(db, `/artifacts/${appId}/users/${userId}/todos`, id);

            try {
                await deleteDoc(todoDocRef);
            } catch (e) {
                console.error("Error deleting document: ", e);
            }
        };
        
        // Handles the edit process.
        const handleEdit = async (id, newText) => {
             if (!db || !userId) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const todoDocRef = doc(db, `/artifacts/${appId}/users/${userId}/todos`, id);
            try {
                await updateDoc(todoDocRef, {
                    text: newText,
                });
            } catch (e) {
                console.error("Error updating document:", e);
            }
        };
        
        // Event listeners for the form and the to-do list.
        window.onload = () => {
            initFirebase();

            const form = document.getElementById('todo-form');
            const input = document.getElementById('todo-input');
            const listContainer = document.getElementById('todo-list-container');

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const text = input.value.trim();
                if (text !== '') {
                    addTodo(text);
                    input.value = '';
                }
            });

            listContainer.addEventListener('click', async (e) => {
                const todoItem = e.target.closest('div[data-id]');
                if (!todoItem) return;
                const id = todoItem.dataset.id;

                if (e.target.closest('.task-checkbox')) {
                    const isChecked = e.target.checked;
                    await toggleComplete(id, !isChecked);
                }

                if (e.target.closest('.delete-btn')) {
                    await deleteTodo(id);
                }
                
                if (e.target.closest('.edit-btn')) {
                    const textSpan = todoItem.querySelector('.task-text');
                    const editInput = todoItem.querySelector('.edit-input');
                    const editBtn = todoItem.querySelector('.edit-btn');
                    const deleteBtn = todoItem.querySelector('.delete-btn');
                    const saveBtn = todoItem.querySelector('.save-btn');
                    const cancelBtn = todoItem.querySelector('.cancel-btn');

                    textSpan.classList.add('hidden');
                    editInput.classList.remove('hidden');
                    editInput.focus();
                    editBtn.classList.add('hidden');
                    deleteBtn.classList.add('hidden');
                    saveBtn.classList.remove('hidden');
                    cancelBtn.classList.remove('hidden');
                }
                
                if (e.target.closest('.save-btn')) {
                    const editInput = todoItem.querySelector('.edit-input');
                    const newText = editInput.value.trim();
                    if (newText !== '') {
                         await handleEdit(id, newText);
                    }
                    
                    const textSpan = todoItem.querySelector('.task-text');
                    const editBtn = todoItem.querySelector('.edit-btn');
                    const deleteBtn = todoItem.querySelector('.delete-btn');
                    const saveBtn = todoItem.querySelector('.save-btn');
                    const cancelBtn = todoItem.querySelector('.cancel-btn');
                    
                    textSpan.classList.remove('hidden');
                    editInput.classList.add('hidden');
                    editBtn.classList.remove('hidden');
                    deleteBtn.classList.remove('hidden');
                    saveBtn.classList.add('hidden');
                    cancelBtn.classList.add('hidden');
                }

                if (e.target.closest('.cancel-btn')) {
                    const textSpan = todoItem.querySelector('.task-text');
                    const editInput = todoItem.querySelector('.edit-input');
                    const editBtn = todoItem.querySelector('.edit-btn');
                    const deleteBtn = todoItem.querySelector('.delete-btn');
                    const saveBtn = todoItem.querySelector('.save-btn');
                    const cancelBtn = todoItem.querySelector('.cancel-btn');

                    textSpan.classList.remove('hidden');
                    editInput.classList.add('hidden');
                    editBtn.classList.remove('hidden');
                    deleteBtn.classList.remove('hidden');
                    saveBtn.classList.add('hidden');
                    cancelBtn.classList.add('hidden');
                }
            });
        };
    </script>
</head>
<body class="bg-white font-sans text-black">
    <div class="min-h-screen flex items-center justify-center p-4 md:p-8">
        <div class="w-full max-w-lg bg-white rounded-2xl shadow-xl p-6 md:p-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-center text-blue-600 mb-6 md:mb-8 tracking-tight">
                To-Do List 📝
            </h1>
            <!-- User ID is displayed here for multi-user context. -->
            <p class="text-sm text-gray-500 text-center mb-4">
                User ID: <span id="user-id" class="font-mono text-xs break-all"></span>
            </p>
            
            <!-- Form for adding new to-dos -->
            <form id="todo-form" class="flex gap-2 md:gap-4 mb-6">
                <input
                    id="todo-input"
                    type="text"
                    placeholder="Add a new task..."
                    class="flex-grow p-3 md:p-4 text-sm md:text-base text-black bg-gray-50 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200"
                />
                <button
                    type="submit"
                    class="p-3 md:p-4 bg-blue-600 text-white rounded-xl shadow-lg hover:bg-blue-700 transition-all duration-200 transform hover:scale-105 active:scale-95"
                >
                    Add
                </button>
            </form>

            <!-- Container for the to-do list items -->
            <div id="todo-list-container" class="space-y-3">
                <!-- To-do items will be dynamically added here by JavaScript -->
            </div>
        </div>
    </div>
</body>
  </html>
      
