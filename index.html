 App;  <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>School Social App</title>
  <!-- Tailwind CSS CDN for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React and ReactDOM CDNs -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel CDN for JSX support in the browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- UUID CDN for unique IDs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
  <!-- bcrypt CDN for password hashing -->
  <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.js"></script>
  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    window.firebase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut };
    window.firestore = { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, query, where };
  </script>
  <style>
    .app-input {
      @apply w-full px-4 py-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500;
    }
    .app-button-primary {
      @apply w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 transition duration-300;
    }
    .app-button-secondary {
      @apply w-full bg-green-600 text-white font-semibold py-3 rounded-lg hover:bg-green-700 transition duration-300;
    }
    .app-button-danger {
      @apply w-full bg-red-500 text-white font-semibold py-3 rounded-lg hover:bg-red-600 transition duration-300;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- Main React application script -->
  <script type="text/babel">
    const { useState, useEffect } = React;
    const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } = window.firebase;
    const { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, query, where } = window.firestore;
    const { v4: uuidv4 } = window.uuid;
    
    // Global variables from the Canvas environment
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
    
    // Hardcoded Admin Credentials
    const ADMIN_ID = 'admin';
    const ADMIN_PASSWORD = 'FARHAN';

    // Helper function to handle sharing on WhatsApp
    const shareOnWhatsApp = (text) => {
      const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`;
      window.open(whatsappUrl, '_blank');
    };

    // Helper function to handle saving an image
    const saveImage = (imageUrl, fileName) => {
      const link = document.createElement('a');
      link.href = imageUrl;
      link.download = fileName;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    // Custom Modal component
    const Modal = ({ title, text, onClose }) => (
      <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div className="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm">
          <h3 className="text-xl font-bold mb-2">{title}</h3>
          <p className="text-gray-700 mb-4">{text}</p>
          <button onClick={onClose} className="bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 transition duration-300 w-full">
            OK
          </button>
        </div>
      </div>
    );

    // Main App component
    const App = () => {
      const [currentPage, setCurrentPage] = useState('login');
      const [isAuthReady, setIsAuthReady] = useState(false);
      const [user, setUser] = useState(null);
      const [role, setRole] = useState('');
      const [schoolId, setSchoolId] = useState('');
      const [loginId, setLoginId] = useState('');
      const [loginPassword, setLoginPassword] = useState('');
      const [registerSchoolId, setRegisterSchoolId] = useState('');
      const [registerPassword, setRegisterPassword] = useState('');
      const [postTitle, setPostTitle] = useState('');
      const [postContent, setPostContent] = useState('');
      const [adminPosts, setAdminPosts] = useState([]);
      const [schoolPosts, setSchoolPosts] = useState([]);
      const [showModal, setShowModal] = useState(false);
      const [modalContent, setModalContent] = useState({ title: '', text: '' });
      const [db, setDb] = useState(null);
      const [auth, setAuth] = useState(null);

      const showMessage = (title, text) => {
        setModalContent({ title, text });
        setShowModal(true);
      };

      const closeModal = () => {
        setShowModal(false);
      };

      useEffect(() => {
        const initializeFirebase = async () => {
          try {
            const app = initializeApp(firebaseConfig);
            const dbInstance = getFirestore(app);
            const authInstance = getAuth(app);
            setDb(dbInstance);
            setAuth(authInstance);

            onAuthStateChanged(authInstance, (user) => {
              if (user) {
                setUser(user);
                setIsAuthReady(true);
              } else {
                setUser(null);
                setIsAuthReady(true);
              }
            });

            if (initialAuthToken) {
              await signInWithCustomToken(authInstance, initialAuthToken);
            } else {
              await signInAnonymously(authInstance);
            }
          } catch (error) {
            console.error("Firebase initialization failed:", error);
            showMessage('Error', "Failed to initialize the app. Please try again later.");
          }
        };

        initializeFirebase();
      }, []);

      useEffect(() => {
        if (isAuthReady && db && role === 'admin') {
          const postsRef = collection(db, `/artifacts/${appId}/public/data/posts`);
          const unsubscribe = onSnapshot(postsRef, (snapshot) => {
            const fetchedPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            fetchedPosts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            setAdminPosts(fetchedPosts);
          });
          return () => unsubscribe();
        }
      }, [isAuthReady, db, role]);

      useEffect(() => {
        if (isAuthReady && db && role === 'school' && schoolId) {
          const postsRef = collection(db, `/artifacts/${appId}/public/data/posts`);
          const q = query(postsRef, where('schoolId', '==', schoolId));
          const unsubscribe = onSnapshot(q, (snapshot) => {
            const fetchedPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            fetchedPosts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            setSchoolPosts(fetchedPosts);
          });
          return () => unsubscribe();
        }
      }, [isAuthReady, db, role, schoolId]);


      const handleRegister = async () => {
        const id = registerSchoolId;
        const password = registerPassword;

        if (!id || !password) {
          showMessage('Error', 'School ID and password are required.');
          return;
        }

        try {
          const docRef = doc(db, `/artifacts/${appId}/public/data/accounts`, id);
          const docSnap = await getDoc(docRef);

          if (docSnap.exists()) {
            showMessage('Error', 'Account ID already exists. Please choose another.');
          } else {
            const saltRounds = 10;
            const hashedPassword = await bcrypt.hash(password, saltRounds);

            await setDoc(docRef, {
              id: id,
              passwordHash: hashedPassword,
              role: 'school',
            });
            showMessage('Success', 'Registration successful! Please log in.');
            setCurrentPage('login');
            setRegisterSchoolId('');
            setRegisterPassword('');
          }
        } catch (error) {
          console.error("Registration failed:", error);
          showMessage('Error', `Registration failed: ${error.message}`);
        }
      };

      const handleLogin = async () => {
        const id = loginId;
        const password = loginPassword;
        
        if (!id || !password) {
          showMessage('Error', 'ID and password are required.');
          return;
        }
        
        if (id === ADMIN_ID && password === ADMIN_PASSWORD) {
          showMessage('Success', 'Admin login successful!');
          setSchoolId(id);
          setRole('admin');
          setCurrentPage('admin-dashboard');
          setLoginId('');
          setLoginPassword('');
          return;
        }

        try {
          const docRef = doc(db, `/artifacts/${appId}/public/data/accounts`, id);
          const docSnap = await getDoc(docRef);

          if (docSnap.exists()) {
            const { passwordHash, role: storedRole } = docSnap.data();
            if (storedRole !== 'school') {
              showMessage('Error', 'Invalid role for this account.');
              return;
            }

            const match = await bcrypt.compare(password, passwordHash);

            if (match) {
              showMessage('Success', 'School login successful!');
              setSchoolId(id);
              setRole('school');
              setCurrentPage('school-dashboard');
              setLoginId('');
              setLoginPassword('');
            } else {
              showMessage('Error', 'Invalid password.');
            }
          } else {
            showMessage('Error', 'Account ID not found.');
          }
        } catch (error) {
          console.error("Login failed:", error);
          showMessage('Error', `Login failed: ${error.message}`);
        }
      };

      const handleLogout = async () => {
        try {
          if (auth.currentUser) {
            await signOut(auth);
          }
          setRole('');
          setSchoolId('');
          setCurrentPage('login');
          showMessage('Logged Out', 'You have been successfully logged out.');
        } catch (error) {
          console.error("Logout failed:", error);
          showMessage('Error', `Logout failed: ${error.message}`);
        }
      };
      
      const handlePost = async () => {
        if (!postTitle || !postContent) {
          showMessage('Error', 'Title and content are required for a post.');
          return;
        }

        const placeholderImageUrl = "https://placehold.co/600x400/292524/fff?text=School+Image";

        try {
          await addDoc(collection(db, `/artifacts/${appId}/public/data/posts`), {
            title: postTitle,
            content: postContent,
            imageUrl: placeholderImageUrl,
            schoolId: schoolId,
            createdAt: new Date().toISOString(),
          });
          showMessage('Success', 'Post created successfully!');
          setPostTitle('');
          setPostContent('');
        } catch (error) {
          console.error("Error adding document: ", error);
          showMessage('Error', `Failed to create post: ${error.message}`);
        }
      };

      const renderLoginPage = () => (
        <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
          <h2 className="text-3xl font-bold text-gray-800 text-center mb-6">Social App Login</h2>
          <input
            type="text"
            placeholder="Account ID (e.g., Ed, As, Ot or admin)"
            className="app-input"
            value={loginId}
            onChange={(e) => setLoginId(e.target.value)}
          />
          <input
            type="password"
            placeholder="Password (FARHAN for admin)"
            className="app-input"
            value={loginPassword}
            onChange={(e) => setLoginPassword(e.target.value)}
          />
          <button onClick={handleLogin} className="app-button-primary mb-2">
            Login
          </button>
          <p className="mt-4 text-center text-sm text-gray-600">
            Don't have a school account?
            <a href="#" onClick={() => setCurrentPage('register')} className="text-indigo-600 font-medium hover:underline">
              Register here
            </a>
          </p>
        </div>
      );

      const renderRegisterPage = () => (
        <div className="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
          <h2 className="text-3xl font-bold text-gray-800 text-center mb-6">School Registration</h2>
          <input
            type="text"
            placeholder="School ID (e.g., Ed, As, Ot)"
            className="app-input"
            value={registerSchoolId}
            onChange={(e) => setRegisterSchoolId(e.target.value)}
          />
          <input
            type="password"
            placeholder="Password"
            className="app-input"
            value={registerPassword}
            onChange={(e) => setRegisterPassword(e.target.value)}
          />
          <button onClick={handleRegister} className="app-button-primary mb-2">
            Register School Account
          </button>
          <p className="mt-4 text-center text-sm text-gray-600">
            Already have an account?
            <a href="#" onClick={() => setCurrentPage('login')} className="text-green-600 font-medium hover:underline">
              Login here
            </a>
          </p>
        </div>
      );

      const renderSchoolDashboard = () => (
        <div className="bg-indigo-500 text-white p-8 rounded-lg shadow-xl w-full max-w-2xl">
          <h2 className="text-3xl font-bold text-center mb-4">Dashboard for {schoolId}</h2>
          <p className="text-center text-gray-200 mb-6">Welcome to your school's private space. You can post news here.</p>
          <div className="mb-6 bg-white p-6 rounded-lg text-gray-800">
            <h3 className="text-2xl font-semibold mb-4">Create a New Post</h3>
            <input
              type="text"
              placeholder="Post Title (e.g., Summer Camp Announcement)"
              className="app-input"
              value={postTitle}
              onChange={(e) => setPostTitle(e.target.value)}
            />
            <textarea
              placeholder="What's the news?"
              className="app-input h-32"
              value={postContent}
              onChange={(e) => setPostContent(e.target.value)}
            ></textarea>
            <div className="flex justify-center items-center h-48 bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 mb-4 text-gray-500">
              Upload School Photo Here
            </div>
            <button onClick={handlePost} className="app-button-primary">
              Post News
            </button>
          </div>
          <div className="mt-8 space-y-6">
            <h3 className="text-2xl font-bold text-center text-white">Your Posts</h3>
            {schoolPosts.length > 0 ? (
              schoolPosts.map(post => (
                <div key={post.id} className="bg-white p-6 rounded-lg shadow-md text-gray-800">
                  <div className="flex items-center mb-4">
                    <img src="https://placehold.co/40x40/E879F9/fff?text=S" alt="School Icon" className="rounded-full mr-4" />
                    <div>
                      <p className="font-semibold text-lg text-indigo-600">{post.schoolId}</p>
                      <p className="text-xs text-gray-500">{new Date(post.createdAt).toLocaleDateString()}</p>
                    </div>
                  </div>
                  <h3 className="text-xl font-bold mb-2">{post.title}</h3>
                  <p className="text-gray-700 mb-4">{post.content}</p>
                  <img src={post.imageUrl} alt="Post Image" className="w-full rounded-lg" />
                </div>
              ))
            ) : (
              <p className="text-center text-gray-200">You haven't posted anything yet.</p>
            )}
          </div>
          <button onClick={handleLogout} className="app-button-danger mt-6">
            Logout
          </button>
        </div>
      );
      
      const renderAdminDashboard = () => (
        <div className="bg-gray-100 p-8 rounded-lg shadow-xl w-full max-w-2xl">
          <h2 className="text-3xl font-bold text-gray-800 text-center mb-4">Admin Dashboard</h2>
          <p className="text-center text-gray-600 mb-6">Logged in as: <span className="font-bold">Admin</span></p>
          <div className="space-y-6">
            {adminPosts.length > 0 ? (
              adminPosts.map(post => (
                <div key={post.id} className="bg-white p-6 rounded-lg shadow-md">
                  <div className="flex items-center mb-4">
                    <img src="https://placehold.co/40x40/E879F9/fff?text=S" alt="School Icon" className="rounded-full mr-4" />
                    <div>
                      <p className="font-semibold text-lg text-indigo-600">Post from {post.schoolId}</p>
                      <p className="text-xs text-gray-500">{new Date(post.createdAt).toLocaleDateString()}</p>
                    </div>
                  </div>
                  <h3 className="text-xl font-bold mb-2">{post.title}</h3>
                  <p className="text-gray-700 mb-4">{post.content}</p>
                  <img src={post.imageUrl} alt="Post Image" className="w-full rounded-lg mb-4" />
                  <div className="flex justify-between">
                    <button
                      onClick={() => saveImage(post.imageUrl, `${post.schoolId}-${post.title}.png`)}
                      className="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-300 text-sm"
                    >
                      Save to Phone
                    </button>
                    <button
                      onClick={() => shareOnWhatsApp(`Check out this post from ${post.schoolId}:\n\n${post.title}\n${post.content}`)}
                      className="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition duration-300 text-sm"
                    >
                      Share on WhatsApp
                    </button>
                  </div>
                </div>
              ))
            ) : (
              <p className="text-center text-gray-500">No posts from schools yet.</p>
            )}
          </div>
          <button onClick={handleLogout} className="app-button-danger mt-6">
            Logout
          </button>
        </div>
      );

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(
        <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
          {isAuthReady && (
            <>
              {currentPage === 'login' && renderLoginPage()}
              {currentPage === 'register' && renderRegisterPage()}
              {currentPage === 'school-dashboard' && renderSchoolDashboard()}
              {currentPage === 'admin-dashboard' && renderAdminDashboard()}
            </>
          )}
          {showModal && <Modal {...modalContent} onClose={closeModal} />}
        </div>
      );
    };
    
    // Initial render
    window.onload = () => {
      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    };
    
  </script>
</body>
</html>
